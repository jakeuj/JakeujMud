<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MUD Web Client</title>
  <style>
    body { font-family: 'Microsoft JhengHei', 'PingFang TC', 'Heiti TC', 'Source Han Sans TC', monospace; background: #000; color: #0f0; padding: 10px; }
    #mud-output { white-space: pre-wrap; height: 70vh; overflow-y: auto; background: #111; padding: 10px; border: 1px solid #333; }
    #mud-input { width: 100%; padding: 10px; background: #222; color: #0f0; border: none; font-family: monospace; }
    #server-settings { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    #mud-host, #mud-port { padding: 5px; background: #222; color: #0f0; border: 1px solid #333; }
    .btn { padding: 5px 10px; background: #333; color: #0f0; border: 1px solid #0f0; cursor: pointer; }
    .btn:hover { background: #444; }
    #server-list { padding: 5px; background: #222; color: #0f0; border: 1px solid #333; }
    #mudlist-link { color: #0f0; text-decoration: none; margin-left: auto; font-size: 0.9em; }
    #mudlist-link:hover { text-decoration: underline; }
    .dropdown-container { position: relative; display: inline-block; }
    .server-count { font-size: 0.8em; color: #0f0; margin-left: 5px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ansi_up@5.0.0/ansi_up.min.js"></script>
</head>
<body>
  <div id="server-settings">
    <div class="dropdown-container">
      <select id="server-list" aria-label="选择MUD服务器">
        <option value="">--选择服务器--</option>
        <option value="kk.muds.idv.tw:4000">萬王之王 King of Kings (kk.muds.idv.tw:4000)</option>
        <option value="210.59.236.38:7788">再戰江湖 The War In Field (210.59.236.38:7788)</option>
        <option value="doom.twmuds.com:4000">失落的國度 DOOM (doom.twmuds.com:4000)</option>
        <option value="catworld.muds.me:5555">小貓的世界 The cat world (catworld.muds.me:5555)</option>
        <option value="sanc.game.tw:4002">聖殿英雄傳說 Sanctuary (sanc.game.tw:4002)</option>
        <option value="fss.twcos.com:5000">五星物語 The Five Star Stories (fss.twcos.com:5000)</option>
        <option value="es.clovers.tw:8000">東方故事 Eastern Stories (es.clovers.tw:8000)</option>
        <option value="windcloud.twmuds.com:8000">風雲再起 Wind Cloud (windcloud.twmuds.com:8000)</option>
        <option value="hopto.mud.ren:4000">異想世界 Break World (hopto.mud.ren:4000)</option>
        <option value="jy.mud.com.tw:6666">金庸修真錄 Jin Yong Record (jy.mud.com.tw:6666)</option>
        <option value="us.muds.net:4000">東方故二天朝遊俠錄 The Celestial Empire (us.muds.net:4000)</option>
        <option value="mud.csie.org:3838">三國歪傳 yyy (mud.csie.org:3838)</option>
        <option value="mud.revivalworld.org:4000">重生的世界 Revival World (mud.revivalworld.org:4000)</option>
      </select>
      <span class="server-count">共13个服务器</span>
    </div>
    <label for="mud-host">服务器:</label>
    <input id="mud-host" type="text" value="kk.muds.idv.tw" />
    <label for="mud-port">端口:</label>
    <input id="mud-port" type="number" value="4000" />
    <button id="connect-btn" class="btn">连接</button>
    <a id="mudlist-link" href="https://www.revivalworld.org/mud/taiwanmudlist" target="_blank" rel="noopener noreferrer">台湾MUD列表</a>
  </div>
  <div id="mud-output"></div>
  <input id="mud-input" type="text" placeholder="输入指令..." disabled />
  <script>
    const output = document.getElementById('mud-output');
    const input = document.getElementById('mud-input');
    const hostInput = document.getElementById('mud-host');
    const portInput = document.getElementById('mud-port');
    const connectBtn = document.getElementById('connect-btn');
    const serverList = document.getElementById('server-list');
    
    let ws = null;
    const ansi_up = new AnsiUp();
    
    // 从本地存储加载设置
    function loadSettings() {
      const savedHost = localStorage.getItem('mudHost');
      const savedPort = localStorage.getItem('mudPort');
      
      if (savedHost) hostInput.value = savedHost;
      if (savedPort) portInput.value = savedPort;
    }
    
    // 保存设置到本地存储
    function saveSettings() {
      localStorage.setItem('mudHost', hostInput.value);
      localStorage.setItem('mudPort', portInput.value);
    }
    
    // 连接到MUD服务器
    function connectToServer() {
      if (ws) {
        ws.close();
        output.innerHTML += '<div style="color: yellow;">断开连接...</div>';
      }
      
      const host = hostInput.value;
      const port = portInput.value;
      
      // 保存设置
      saveSettings();
      
      output.innerHTML += `<div style="color: yellow;">正在连接到 ${host}:${port}...</div>`;
      
      // 连接到websocket服务器，传递MUD服务器信息
      ws = new WebSocket(`ws://${location.host}?host=${host}&port=${port}`);
      
      ws.onopen = () => {
        input.disabled = false;
        input.focus();
        connectBtn.textContent = "断开";
      };
      
      ws.onclose = () => {
        input.disabled = true;
        connectBtn.textContent = "连接";
        output.innerHTML += '<div style="color: yellow;">连接已关闭</div>';
      };
      
      ws.onmessage = (event) => {
        const html = ansi_up.ansi_to_html(event.data);
        output.innerHTML += html;
        output.scrollTop = output.scrollHeight;
      };
      
      ws.onerror = (error) => {
        output.innerHTML += '<div style="color: red;">WebSocket连接错误</div>';
        console.error('WebSocket连接错误:', error);
        input.disabled = true;
      };
    }
    
    // 处理服务器列表选择
    serverList.addEventListener('change', function() {
      if (this.value) {
        const [host, port] = this.value.split(':');
        hostInput.value = host;
        portInput.value = port;
      }
    });
    
    // 加载保存的设置
    loadSettings();
    
    // 添加事件监听器
    connectBtn.addEventListener('click', connectToServer);
    
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !input.disabled && ws) {
        ws.send(input.value + '\r\n');
        input.value = '';
      }
    });
  </script>
</body>
</html>